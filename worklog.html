<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Worklog — Figmark Infotek</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body { background:#a6d8f0; }
    .navbar { background:#0a4a82; }
    .btn-brand { background:#0a4a82; color:#fff; }
    .btn-brand:hover { background:#06365d; }
    .date-row { background:#fff; border-radius:12px; padding:15px; margin-bottom:15px; box-shadow:0 3px 6px rgba(0,0,0,.1); }
    .date-row.locked textarea { background:#f8d7da; }
    .date-row.sunday textarea { background:#e2e3e5; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }

    /* ✅ Responsive: on small screens, stack buttons below date */
    @media (max-width: 576px) {
      .date-row .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
      }
      .date-row .d-flex strong {
        margin-bottom: 8px;
      }
      .date-row .d-flex div {
        width: 100%;
      }
      .date-row .btn {
        width: 48%;
        margin-bottom: 6px;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">Figmark Infotek — Worklog</span>
      <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
    </div>
  </nav>

  <!-- Container -->
  <div class="container my-4">
    <!-- User info -->
    <h3 id="username"></h3>
    <p id="useremail" class="text-muted"></p>

    <!-- Alerts -->
    <div id="msg" class="d-none"></div>

    <!-- Logs -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-3">Last 5 Days Work Log</h5>

        <!-- Loading Spinner -->
        <div id="loading" class="text-center my-3 d-none">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading worklogs...</p>
        </div>

        <div id="loglist"></div>
      </div>
    </div>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz5vloRwy0mumeIzmn39tD1LA6IBXlWiRui1Dwz8FSZ-S0EDnutehxnLaCO9YPDN-1E/exec";

// ---- Session guard ----
const name  = localStorage.getItem("name")  || "";
const email = localStorage.getItem("email") || "";
if (!email) window.location.href = "index.html";

// Show user info
document.getElementById("username").textContent = name ? `Welcome, ${name}` : "Welcome";
document.getElementById("useremail").textContent = email;

// ---- Helpers ----
function parseDMY(dmy){
  const m = dmy.match(/^(\d{2})[.\-](\d{2})[.\-](\d{4})$/);
  if (!m) return new Date('');
  return new Date(+m[3], +m[2]-1, +m[1]);
}
function isSundayDMY(dmy){ return parseDMY(dmy).getDay() === 0; }

const msgBox = document.getElementById("msg");
function flash(type, text){
  msgBox.className = `alert alert-${type}`;
  msgBox.textContent = text;
  msgBox.style.animation = "fadeIn 0.5s";
  setTimeout(()=> msgBox.className = "d-none", 3000);
}

// ---- Row Template ----
function rowTemplate(item, index){
  const sunday   = isSundayDMY(item.date);
  const rowClass = item.locked ? "locked" : sunday ? "sunday" : "normal";

  return `
    <div class="date-row ${rowClass}" style="animation-delay:${index*0.1}s;">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>${item.date}${item.locked ? " (Locked)": ""}${sunday ? " (Sunday)" : ""}</strong>
        <div>
          <button class="btn btn-sm btn-warning me-2" ${item.locked || sunday ? "disabled": ""} onclick="enableEdit('${item.date}', ${item.locked})">
            Edit
          </button>
          <button class="btn btn-sm btn-success" ${item.locked || sunday ? "disabled": ""} onclick="saveLog('${item.date}')">
            Save
          </button>
        </div>
      </div>
      <textarea class="form-control" id="ta-${item.date}" rows="3" disabled>${item.log||""}</textarea>
    </div>
  `;
}

// ---- Enable edit ----
function enableEdit(dateDMY, locked){
  if (locked) {
    flash("danger","This log is locked by admin.");
    return;
  }
  const ta = document.getElementById(`ta-${dateDMY}`);
  if (ta) ta.removeAttribute("disabled");
}

// ---- Load logs ----
async function getLogs(){
  const logList = document.getElementById("loglist");
  const loading = document.getElementById("loading");

  // show spinner
  loading.classList.remove("d-none");
  logList.innerHTML = "";

  try{
    const res  = await fetch(API_URL, { method:"POST", body:new URLSearchParams({action:"getLogs", email}) });
    const data = await res.json();

    // hide spinner
    loading.classList.add("d-none");

    if (data.status !== "ok"){
      logList.innerHTML = "";
      flash("danger", data.msg || "Could not load logs");
      return;
    }
    if (!Array.isArray(data.logs) || data.logs.length === 0){
      logList.innerHTML =
        `<div class="text-muted">No recent date columns found in the sheet. Ask admin to add headers like <b>${new Date().toLocaleDateString("en-GB").replace(/\//g,".")}</b>.</div>`;
      return;
    }

    // ✅ Always include today's row
    const todayStr = new Date().toLocaleDateString("en-GB").replace(/\//g,".");
    if (!data.logs.some(l => l.date === todayStr)) {
      data.logs.unshift({date: todayStr, log:"", locked:false});
    }

    logList.innerHTML = data.logs.map((row,i)=>rowTemplate(row,i)).join("");
  }catch(err){
    console.error(err);
    loading.classList.add("d-none");
    flash("danger","Error connecting to server.");
  }
}

// ---- Save one log ----
async function saveLog(dateDMY){
  const ta  = document.getElementById(`ta-${dateDMY}`);
  const log = (ta?.value || "").trim();
  if (!log){ flash("danger","Cannot save empty log."); return; }

  try{
    const res  = await fetch(API_URL,{
      method:"POST",
      body:new URLSearchParams({action:"saveLog", email, date:dateDMY, log})
    });
    const data = await res.json();
    if (data.status === "ok") { flash("success","Saved!"); getLogs(); }
    else { flash("danger", data.msg || "Could not save"); }
  }catch(err){
    console.error(err);
    flash("danger","Error saving log.");
  }
}

// ---- Logout ----
function logout(){
  localStorage.clear();
  window.location.href = "index.html";
}

getLogs();
</script>
</body>
</html>
